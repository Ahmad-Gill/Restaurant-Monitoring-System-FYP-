{% extends "HtmlFiles/Base.html" %}

{% block title %}Preprocessing{% endblock %}
{% block home_active %}active{% endblock %}

{% load static %}
{% block body %}
<link href="{% static 'CssFiles/Add_Video.css' %}" rel="stylesheet">
<link href="{% static 'CssFiles/variables.css' %}" rel="stylesheet">

<div class="container_">
    <h1>Preprocessing Step 1</h1>
    <p style="margin: 20px 0; line-height: 1.6;">
        Select grids from the image to define the table area. Click on a grid to select it (turns green). Hover over selected grids to highlight them in red. 
        Ensure all necessary grids are selected, then click <strong>"Submit Grids"</strong> to proceed.
    </p>
    
    <div class="flex-row">
        <form method="POST" enctype="multipart/form-data" action="{% url 'preprocessing' %}">
            {% csrf_token %}
            <button type="submit" class="submit-btn" id="startBtn">Get Frame</button>
        </form>
        <div id="submitSection">
            <button id="submitGridsBtn">Submit Grids</button>
        </div>
    </div>
    {% if frame_rgb %}
    <h2>Extracted Frame with Grids:</h2>
    <div id="imageContainer" style="position: relative; display: inline-block;">
        <img src="data:image/png;base64,{{ frame_rgb }}" alt="Frame with grid" style="max-width: 100%; height: auto;" />
        <div id="gridOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    </div>
    <br><br>
    <div id="gridInputSection">
    </div>
    {% else %}
    <p>No frame available to display.</p>
    {% endif %}
</div>

<div id="overlay" class="overlay">
    <div id="lottie-animation" data-animation-path="{% static 'Animation/Animation1.json' %}" style="width: 50vw; height: auto; margin: 0 auto;"></div>
</div>

<!-- Include Lottie JS from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.4/lottie.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const gridOverlay = document.getElementById("gridOverlay");
        const gridNumbers = []; 
        const gridList = document.getElementById("gridList");
        const submitGridsBtn = document.getElementById("submitGridsBtn");
        const overlay = document.getElementById("overlay");
        const rows = 20;
        const cols = 20;
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const gridCell = document.createElement("div");
                gridCell.style.position = "absolute";
                gridCell.style.border = "1px solid rgba(0, 0, 0, 0.5)";
                gridCell.style.width = `${100 / cols}%`;
                gridCell.style.height = `${100 / rows}%`;
                gridCell.style.top = `${(row * 100) / rows}%`;
                gridCell.style.left = `${(col * 100) / cols}%`;
                gridCell.style.boxSizing = "border-box";
                gridCell.setAttribute("data-grid", `${row * cols + col + 1}`);
                gridCell.style.cursor = "pointer";
                gridCell.style.pointerEvents = "auto";
                gridCell.addEventListener("mouseenter", () => {
                    if (gridNumbers.includes(gridCell.getAttribute("data-grid"))) {
                        gridCell.style.backgroundColor = "rgba(255, 0, 0, 0.5)"; 
                    } else {
                        gridCell.style.backgroundColor = "rgba(255, 255, 0, 0.5)"; 
                    }
                });
                gridCell.addEventListener("mouseleave", () => {
                    if (gridNumbers.includes(gridCell.getAttribute("data-grid"))) {
                        gridCell.style.backgroundColor = "rgba(0, 255, 0, 0.5)"; 
                    } else {
                        gridCell.style.backgroundColor = "transparent"; 
                    }
                });
                gridCell.addEventListener("click", () => {
                    const gridNumber = gridCell.getAttribute("data-grid");
                    if (!gridNumbers.includes(gridNumber)) {
                        gridNumbers.push(gridNumber);
                        gridCell.style.backgroundColor = "rgba(0, 255, 0, 0.5)";
                    } else {
                        gridNumbers.splice(gridNumbers.indexOf(gridNumber), 1);
                        gridCell.style.backgroundColor = "transparent"; 
                    }
                    displayGrids();
                });
    
                gridOverlay.appendChild(gridCell);
            }
        }
        function displayGrids() {
            gridList.innerHTML = '';
            gridNumbers.forEach((grid, index) => {
                const listItem = document.createElement("li");
                listItem.textContent = `Grid ${grid}`;
                listItem.style.marginBottom = '10px';
                gridList.appendChild(listItem);
            });
        }
    
        submitGridsBtn.addEventListener("click", function () {
            if (gridNumbers.length === 0) {
                alert("No grids to submit. Please select grids before submitting.");
                return;
            }
    
            sendGridsToServer(gridNumbers);
        });
        function sendGridsToServer(grids) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            overlay.style.display = 'block';
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/preprocessing_1", true);
            xhr.setRequestHeader("X-CSRFToken", csrfToken);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    overlay.style.display = 'none';
                    if (xhr.status === 200) {
                        window.location.href = '/preprocessing_1';
                        gridNumbers.length = 0; 
                        displayGrids();
                    } else {
                        alert("Error submitting grids.");
                    }
                }
            };
    
            xhr.send(JSON.stringify({ grids })); 
        }
    });
    
</script>


{% endblock %}
